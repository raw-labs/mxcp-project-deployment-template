#!/bin/bash
set -e

# 🔧 Squirro Setup Script for UAE MXCP Server
# ============================================
# ⚠️  IMPORTANT: This script creates TEMPLATE files that MUST be edited by Squirro
# ⚠️  DO NOT use these files as-is - they contain placeholder values
# ⚠️  Squirro MUST customize all configuration for their environment

echo "🔧 Setting up UAE MXCP Server for Squirro deployment..."
echo "⚠️  WARNING: This creates TEMPLATE files that MUST be edited!"

# Check if we're in the right repository
if [ ! -f "mxcp-site.yml" ] || [ ! -d "tools" ]; then
    echo "❌ Error: This doesn't appear to be a UAE MXCP repository"
    echo "   Make sure you're in the root directory of the forked repository"
    exit 1
fi

# 1. Create Squirro marker file
echo "📝 Creating Squirro configuration marker..."
mkdir -p .github
touch .github/.squirro-configured
echo "squirro-deployment" > .github/.squirro-configured

# 2. Copy Squirro-specific GitHub workflow
echo "📋 Setting up Squirro EKS deployment workflow..."
cp .squirro/workflows/deploy-eks.yml .github/workflows/

# 3. Update mxcp-site.yml for Squirro profile
echo "⚙️  Configuring MXCP for Squirro environment..."
if ! grep -q "profile: squirro" mxcp-site.yml; then
    sed -i 's/profile: prod/profile: squirro/' mxcp-site.yml
    echo "   ✅ Updated profile to 'squirro'"
fi

# 4. Add upstream remote for RAW Labs updates
echo "🔗 Setting up upstream remote for RAW Labs updates..."
if ! git remote | grep -q "upstream"; then
    git remote add upstream https://github.com/raw-labs/uae-mxcp-server.git
    echo "   ✅ Added upstream remote"
else
    echo "   ℹ️  Upstream remote already exists"
fi

# 5. Create Squirro-specific profiles
echo "📄 Creating Squirro dbt profiles template..."
cat > profiles-squirro.yml << 'EOF'
# ⚠️  TEMPLATE FILE - MUST BE EDITED BY SQUIRRO
# ⚠️  DO NOT use as-is - customize for your environment
# ⚠️  Update paths, connection settings, and performance configs

uaeme-licenses-mxcp:
  target: squirro
  outputs:
    squirro:
      type: duckdb
      path: data/db-squirro.duckdb  # ⚠️  EDIT: Use your database path
      threads: 4                   # ⚠️  EDIT: Adjust for your environment
EOF

echo ""
echo "✅ Template files created!"
echo ""
echo "🚨 CRITICAL: You MUST edit these files before deployment:"
echo ""
echo "📝 Required edits:"
echo "1. Edit deployment/config.env:"
echo "   - Replace AWS_ACCOUNT_ID with your AWS account"
echo "   - Update AWS_REGION for your preferred region"
echo "   - Change ECR_REPOSITORY and SERVICE_NAME for Squirro"
echo ""
echo "2. Edit .github/workflows/deploy-eks.yml:"
echo "   - Replace YOUR_AWS_ACCOUNT_ID with actual account ID"
echo "   - Replace squirro-cluster with actual EKS cluster name"
echo "   - Update service names and namespaces"
echo "   - Customize resource limits and configurations"
echo ""
echo "3. Edit profiles-squirro.yml:"
echo "   - Update database paths for Squirro environment"
echo "   - Configure connection settings"
echo ""
echo "3. Configure GitHub secrets in your forked repository:"
echo "   - AWS_ACCOUNT_ID (your actual AWS account)"
echo "   - EKS_CLUSTER_NAME (your actual cluster name)"
echo "   - AWS_ACCESS_KEY_ID (for EKS access)"
echo "   - AWS_SECRET_ACCESS_KEY (for EKS access)"
echo "   - OPENAI_API_KEY (for testing - optional)"
echo ""
echo "4. Test locally first:"
echo "   ./scripts/run_etl_and_tests.sh"
echo ""
echo "5. Only after customization, commit and push:"
echo "   git add -A"
echo "   git commit -m 'Configure for Squirro EKS deployment'"
echo "   git push origin main"
echo ""
echo "6. To get updates from RAW Labs:"
echo "   ./.squirro/merge-from-raw.sh"
echo ""
echo "⚠️  DO NOT deploy without editing the template files first!"
echo "🚀 After customization, repository will be ready for Squirro deployment!"
