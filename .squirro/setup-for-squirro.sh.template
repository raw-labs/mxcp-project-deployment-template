#!/bin/bash
set -e

# 🔧 Squirro Setup Script for {{PROJECT_NAME}} MXCP Server
# ============================================
# ⚠️  IMPORTANT: This script creates TEMPLATE files that MUST be edited by Squirro
# ⚠️  DO NOT use these files as-is - they contain placeholder values
# ⚠️  Squirro MUST customize all configuration for their environment

echo "🔧 Setting up {{PROJECT_NAME}} MXCP Server for Squirro deployment..."
echo "⚠️  WARNING: This creates TEMPLATE files that MUST be edited!"

# Check if we're in the right repository
if [ ! -f "mxcp-site.yml" ] || [ ! -d "tools" ]; then
    echo "❌ Error: This doesn't appear to be an MXCP repository"
    echo "   Make sure you're in the root directory of the forked repository"
    exit 1
fi

# 1. Create Squirro marker file
echo "📝 Creating Squirro configuration marker..."
mkdir -p .github
touch .github/.squirro-configured
echo "squirro-deployment" > .github/.squirro-configured

# 2. Copy Squirro's build-and-push workflow (ECR only, no App Runner)
echo "📋 Setting up Squirro's build-and-push workflow..."
cp .squirro/workflows/build-and-push-to-ecr.yml .github/workflows/
rm -f .github/workflows/deploy.yml  # Remove RAW's App Runner deployment
echo "   ✅ Replaced RAW's App Runner workflow with Squirro's ECR-only workflow"
echo "   ℹ️  External system (Flux) will handle K8s deployment automatically"

# 3. Update mxcp-site.yml for Squirro profile
echo "⚙️  Configuring MXCP for Squirro environment..."
if ! grep -q "profile: squirro" mxcp-site.yml; then
    sed -i 's/profile: prod/profile: squirro/' mxcp-site.yml
    echo "   ✅ Updated profile to 'squirro'"
fi

# 4. Add upstream remote for RAW Labs updates
echo "🔗 Setting up upstream remote for RAW Labs updates..."
if ! git remote | grep -q "upstream"; then
    git remote add upstream https://github.com/raw-labs/{{PROJECT_NAME}}-mxcp-server.git
    echo "   ✅ Added upstream remote"
else
    echo "   ℹ️  Upstream remote already exists"
fi

# 5. Create Squirro-specific profiles
echo "📄 Creating Squirro dbt profiles template..."
cat > profiles-squirro.yml << 'EOF'
# ⚠️  TEMPLATE FILE - MUST BE EDITED BY SQUIRRO
# ⚠️  DO NOT use as-is - customize for your environment
# ⚠️  Update paths, connection settings, and performance configs

{{PROJECT_NAME}}-mxcp:
  target: squirro
  outputs:
    squirro:
      type: duckdb
      path: data/db-squirro.duckdb  # ⚠️  EDIT: Use your database path
      threads: 4                   # ⚠️  EDIT: Adjust for your environment
EOF

echo ""
echo "✅ Template files created!"
echo ""
echo "🚨 CRITICAL: You MUST edit these files before deployment:"
echo ""
echo "📝 Required configuration for {{PROJECT_NAME}} MXCP Server:"
echo ""
echo "1. Review deployment/config.env:"
echo "   - Contains default AWS configuration"
echo "   - Edit if you need different defaults"
echo "   - Values can be overridden by GitHub Variables"
echo ""
echo "2. Configure GitHub Variables (optional overrides):"
echo "   - AWS_ACCOUNT_ID (override config.env value)"
echo "   - AWS_REGION (override config.env value)"
echo "   - ECR_REPOSITORY (override config.env value)"
echo "   - CPU_SIZE (override config.env value, e.g., '4 vCPU')"
echo "   - MEMORY_SIZE (override config.env value, e.g., '8 GB')"
echo ""
echo "3. Configure GitHub Secrets (required):"
echo "   - AWS_ACCESS_KEY_ID (for ECR push access)"
echo "   - AWS_SECRET_ACCESS_KEY (for ECR push access)"
echo "   - MXCP_DATA_ACCESS_KEY_ID (if using S3 data)"
echo "   - MXCP_DATA_SECRET_ACCESS_KEY (if using S3 data)"
echo "   - OPENAI_API_KEY (for LLM functionality)"
echo "   - ANTHROPIC_API_KEY (optional)"
echo ""
echo "4. Edit profiles-squirro.yml:"
echo "   - Update database paths for Squirro environment"
echo "   - Configure connection settings"
echo ""
echo "5. Test locally first:"
echo "   just full-pipeline  # Run complete ETL and tests"
echo "   just test-all      # Run all tests including evals"
echo ""
echo "6. Only after customization, commit and push:"
echo "   git add -A"
echo "   git commit -m 'Configure for Squirro deployment'"
echo "   git push origin main"
echo ""
echo "7. To get updates from RAW Labs:"
echo "   ./.squirro/merge-from-raw.sh"
echo ""
echo "⚠️  DO NOT deploy without editing the template files first!"
echo "🚀 After customization, repository will be ready for Squirro deployment!"
