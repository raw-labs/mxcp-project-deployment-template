# {{PROJECT_NAME}} MXCP Server - Modern Task Runner
# Replaces overlapping shell scripts with clean task definitions

# Download {{PROJECT_NAME}} data from S3
download:
    @echo "ğŸ“¥ Downloading {{PROJECT_NAME}} data..."
    {{DATA_DOWNLOAD_COMMAND}}
    @echo "âœ… Data download complete"

# Build dbt models from downloaded data
build-models:
    @echo "ğŸ—ï¸ Building dbt models..."
    dbt deps
    {{DBT_RUN_COMMAND}}
    @echo "âœ… dbt models built successfully"

# Run data quality tests
test-data:
    @echo "ğŸ§ª Running data quality tests..."
    {{DBT_TEST_COMMAND}}
    @echo "âœ… Data quality tests passed"

# Run tool tests (Level 2 testing)
test-tools:
    @echo "ğŸ”§ Running tool tests..."
    python tests/test.py tool
    @echo "âœ… Tool tests passed"

# Run API tests (for API-based projects)
test-api:
    @echo "ğŸ”Œ Running API tests..."
    {{API_TEST_COMMAND}}
    @echo "âœ… API tests completed"

# Run LLM evaluation tests (Level 3 testing - requires OPENAI_API_KEY)
test-evals:
    @echo "ğŸ¤– Running LLM evaluation tests..."
    @echo "âš ï¸  This requires OPENAI_API_KEY and will incur costs"
    -{{MXCP_EVALS_COMMANDS}}
    @echo "âœ… LLM evaluation tests completed (failures are non-blocking)"

# Validate YAML configurations (replaces run_tests.sh)
test-config:
    @echo "ğŸ“ Validating MXCP configuration..."
    python -c "import yaml; yaml.safe_load(open('mxcp-site.yml')); print('âœ… mxcp-site.yml is valid')"
    @echo "ğŸ”§ Validating tool configurations..."
    python -c "import yaml, glob; [yaml.safe_load(open(f)) for f in glob.glob('tools/*.yml')]; print('âœ… All tool configurations valid')"

# Prepare data for Docker build (replaces prepare-data-for-build.sh)
prepare-build: download build-models
    @echo "âœ… Data prepared for Docker build"

# Complete development pipeline (replaces run_etl_and_tests.sh)
full-pipeline: download build-models test-data test-tools
    @echo "ğŸ‰ Complete pipeline finished successfully!"

# Complete testing suite (all 3 levels - requires OPENAI_API_KEY)
test-all: test-data test-tools test-api test-evals
    @echo "ğŸ‰ All testing levels completed!"
    @echo "âœ… Level 1: Data quality tests (dbt)"
    @echo "âœ… Level 2: Tool tests (MXCP tools)"
    @echo "âœ… Level 2: API tests (if applicable)"
    @echo "âœ… Level 3: LLM evaluation tests (non-blocking)"

# Quick configuration validation (no data download needed)
validate-config: test-config
    @echo "âœ… Configuration validation passed"

# Full CI tests with data (for deploy workflow)
ci-tests-with-data: test-config download build-models test-data
    @echo "âœ… Full CI tests with data passed"

# Development workflow (standard - no LLM costs)
dev: full-pipeline
    @echo "ğŸš€ Development environment ready"

# Development workflow with full testing (includes LLM evals - costs apply)
dev-full: download build-models test-all
    @echo "ğŸš€ Development environment ready with full testing suite"

# Show available tasks
default:
    @just --list
