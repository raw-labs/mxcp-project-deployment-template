# {{PROJECT_NAME}} MXCP Server - Modern Task Runner
# Replaces overlapping shell scripts with clean task definitions

# Download {{PROJECT_NAME}} data from S3
download:
    @echo "📥 Downloading {{PROJECT_NAME}} data..."
    {{DATA_DOWNLOAD_COMMAND}}
    @echo "✅ Data download complete"

# Build dbt models from downloaded data
build-models:
    @echo "🏗️ Building dbt models..."
    dbt deps
    {{DBT_RUN_COMMAND}}
    @echo "✅ dbt models built successfully"

# Run data quality tests
test-data:
    @echo "🧪 Running data quality tests..."
    {{DBT_TEST_COMMAND}}
    @echo "✅ Data quality tests passed"

# Run tool tests (Level 2 testing)
test-tools:
    @echo "🔧 Running tool tests..."
    python tests/test.py tool
    @echo "✅ Tool tests passed"

# Run API tests (for API-based projects)
test-api:
    @echo "🔌 Running API tests..."
    {{API_TEST_COMMAND}}
    @echo "✅ API tests completed"

# Run LLM evaluation tests (Level 3 testing - requires OPENAI_API_KEY)
test-evals:
    @echo "🤖 Running LLM evaluation tests..."
    @echo "⚠️  This requires OPENAI_API_KEY and will incur costs"
    -{{MXCP_EVALS_COMMANDS}}
    @echo "✅ LLM evaluation tests completed (failures are non-blocking)"

# Validate YAML configurations (replaces run_tests.sh)
test-config:
    @echo "📝 Validating MXCP configuration..."
    python -c "import yaml; yaml.safe_load(open('mxcp-site.yml')); print('✅ mxcp-site.yml is valid')"
    @echo "🔧 Validating tool configurations..."
    python -c "import yaml, glob; [yaml.safe_load(open(f)) for f in glob.glob('tools/*.yml')]; print('✅ All tool configurations valid')"

# Prepare data for Docker build (replaces prepare-data-for-build.sh)
prepare-build: download build-models
    @echo "✅ Data prepared for Docker build"

# Complete development pipeline (replaces run_etl_and_tests.sh)
full-pipeline: download build-models test-data test-tools
    @echo "🎉 Complete pipeline finished successfully!"

# Complete testing suite (all 3 levels - requires OPENAI_API_KEY)
test-all: test-data test-tools test-api test-evals
    @echo "🎉 All testing levels completed!"
    @echo "✅ Level 1: Data quality tests (dbt)"
    @echo "✅ Level 2: Tool tests (MXCP tools)"
    @echo "✅ Level 2: API tests (if applicable)"
    @echo "✅ Level 3: LLM evaluation tests (non-blocking)"

# Quick configuration validation (no data download needed)
validate-config: test-config
    @echo "✅ Configuration validation passed"

# Full CI tests with data (for deploy workflow)
ci-tests-with-data: test-config download build-models test-data
    @echo "✅ Full CI tests with data passed"

# Development workflow (standard - no LLM costs)
dev: full-pipeline
    @echo "🚀 Development environment ready"

# Development workflow with full testing (includes LLM evals - costs apply)
dev-full: download build-models test-all
    @echo "🚀 Development environment ready with full testing suite"

# Show available tasks
default:
    @just --list
